<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Status</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #4a1e9e, #1f074f);
        }

        .container {
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
            color: #fff
        }

        .success-icon {
            background: #4CAF50
        }

        .failed-icon {
            background: #ad0808
        }

        .title {
            font-size: 22px;
            margin-bottom: 8px
        }

        .txn {
            color: #666;
            margin-bottom: 20px
        }

        .home-button {
            padding: 12px 24px;
            background: #1f074f;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            text-decoration: none;
            display: inline-block
        }

        .d-none {
            display: none
        }

        .loader {
            border: 4px solid #fff;
            border-top: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(360deg)
            }
        }
    </style>
</head>

<body>
    <div class="container d-none" id="result">
        <div id="icon" class="icon">
            <div id="loader" class="loader"></div>
            <span id="symbol" class="d-none"></span>
        </div>
        <h1 id="title" class="title"></h1>
        <p class="txn">Transaction: <span id="txn">-</span></p>
        <a id="home" href="/stripe" class="home-button">Back to payments</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function getQueryParam(name) { return new URLSearchParams(window.location.search).get(name); }

            const result = document.getElementById('result');
            const loader = document.getElementById('loader');
            const symbol = document.getElementById('symbol');
            const icon = document.getElementById('icon');
            const title = document.getElementById('title');
            const txn = document.getElementById('txn');

            const sessionId = getQueryParam('session_id');
            let displayTxn = 'N/A';

            result.classList.remove('d-none');

            if (!sessionId) {
                loader.style.display = 'none';
                symbol.classList.remove('d-none');
                symbol.innerText = 'X';
                icon.classList.add('failed-icon');
                title.innerText = 'Missing session_id';
                return;
            }

            fetch('/stripe/VerifyPayment.php', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId })
            })
                .then(res => res.json())
                .then(data => {
                    loader.style.display = 'none';
                    symbol.classList.remove('d-none');

                    // Determine success
                    let success = false;
                    const piStatus = data.payment_status || (data.session && data.session.payment_status) || null;
                    if (piStatus) {
                        const ps = String(piStatus).toLowerCase();
                        if (ps === 'succeeded' || ps === 'paid') success = true;
                    }

                    // transaction id: prefer payment_intent.id (if object) or payment_intent string, otherwise session id
                    if (data.session) {
                        if (data.session.payment_intent) {
                            if (typeof data.session.payment_intent === 'object' && data.session.payment_intent.id) {
                                displayTxn = data.session.payment_intent.id;
                            } else {
                                displayTxn = data.session.payment_intent;
                            }
                        } else if (data.session.id) {
                            displayTxn = data.session.id;
                        }
                    }
                    else displayTxn = sessionId;

                    txn.innerText = displayTxn;

                    if (success) {
                        symbol.innerText = 'âœ“';
                        icon.classList.add('success-icon');
                        title.innerText = 'Payment Successful!';
                    } else {
                        symbol.innerText = 'X';
                        icon.classList.add('failed-icon');
                        title.innerText = (data.error && data.error.message) ? data.error.message : 'Payment Failed or Pending';
                    }
                })
                .catch(err => {
                    loader.style.display = 'none';
                    symbol.classList.remove('d-none');
                    symbol.innerText = 'X';
                    icon.classList.add('failed-icon');
                    title.innerText = 'Error checking payment';
                    txn.innerText = sessionId;
                    console.error(err);
                });
        });
    </script>
</body>

</html>